name: Parse Theological Text

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL of the theological work (table of contents or full-text page)'
        required: true
        type: string
      work_id:
        description: 'Work ID in kebab-case (e.g. "bondage-1525", "city-of-god")'
        required: true
        type: string
      title:
        description: 'Full title of the work'
        required: true
        type: string
      short_title:
        description: 'Abbreviated title (e.g. "ST", "Institutes")'
        required: false
        type: string
      year:
        description: 'Year of original publication'
        required: false
        type: string
      original_lang:
        description: 'Original language code'
        required: false
        type: choice
        default: 'la'
        options:
          - la
          - en
          - de
          - fr
          - grc
      author_id:
        description: 'Author ID â€” use existing (john-calvin, peter-martyr-vermigli, thomas-aquinas) or enter a new one'
        required: true
        type: string
      author_name:
        description: 'Author full name (only needed for NEW authors)'
        required: false
        type: string
      author_short_name:
        description: 'Author short name, e.g. "Luther" (only needed for NEW authors)'
        required: false
        type: string
      author_tradition:
        description: 'Theological tradition (only needed for NEW authors)'
        required: false
        type: choice
        default: 'Reformed'
        options:
          - Reformed
          - Roman Catholic
          - Lutheran
          - Anglican
          - Orthodox
          - Anabaptist
          - Other
      site_name:
        description: 'Source website name (e.g. "CCEL", "EEBO", "archive.org")'
        required: false
        type: string
      edition_id:
        description: 'Edition ID (e.g. "beveridge-1845")'
        required: false
        type: string
      edition_lang:
        description: 'Language of the online edition'
        required: false
        type: choice
        default: 'en'
        options:
          - en
          - la
          - de
          - fr
          - grc
      translator:
        description: 'Translator name (leave blank if original language)'
        required: false
        type: string
      edition_year:
        description: 'Edition year'
        required: false
        type: string
      levels:
        description: 'Hierarchy level names, comma-separated (e.g. "book,chapter" or "part,question,article")'
        required: false
        type: string
        default: 'book,chapter'
      mode:
        description: 'How to detect the work structure from the page'
        required: false
        type: choice
        default: 'toc'
        options:
          - toc
          - headings
      fetch_content:
        description: 'Fetch each section page for topic analysis? (slower but much better topics)'
        required: false
        type: boolean
        default: true

jobs:
  parse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r tools/requirements.txt

      - name: Run parser
        env:
          INPUT_URL: ${{ inputs.url }}
          INPUT_WORK_ID: ${{ inputs.work_id }}
          INPUT_TITLE: ${{ inputs.title }}
          INPUT_SHORT_TITLE: ${{ inputs.short_title }}
          INPUT_YEAR: ${{ inputs.year }}
          INPUT_ORIGINAL_LANG: ${{ inputs.original_lang }}
          INPUT_AUTHOR_ID: ${{ inputs.author_id }}
          INPUT_AUTHOR_NAME: ${{ inputs.author_name }}
          INPUT_AUTHOR_SHORT_NAME: ${{ inputs.author_short_name }}
          INPUT_AUTHOR_TRADITION: ${{ inputs.author_tradition }}
          INPUT_SITE_NAME: ${{ inputs.site_name }}
          INPUT_EDITION_ID: ${{ inputs.edition_id }}
          INPUT_EDITION_LANG: ${{ inputs.edition_lang }}
          INPUT_TRANSLATOR: ${{ inputs.translator }}
          INPUT_EDITION_YEAR: ${{ inputs.edition_year }}
          INPUT_LEVELS: ${{ inputs.levels }}
          INPUT_MODE: ${{ inputs.mode }}
          INPUT_FETCH_CONTENT: ${{ inputs.fetch_content }}
        run: |
          ARGS=()
          ARGS+=("$INPUT_URL")
          ARGS+=(--work-id "$INPUT_WORK_ID")
          ARGS+=(--title "$INPUT_TITLE")
          ARGS+=(--author-id "$INPUT_AUTHOR_ID")
          ARGS+=(--mode "$INPUT_MODE")

          [ -n "$INPUT_SHORT_TITLE" ]       && ARGS+=(--short-title "$INPUT_SHORT_TITLE")
          [ -n "$INPUT_YEAR" ]              && ARGS+=(--year "$INPUT_YEAR")
          [ -n "$INPUT_ORIGINAL_LANG" ]     && ARGS+=(--original-lang "$INPUT_ORIGINAL_LANG")
          [ -n "$INPUT_AUTHOR_NAME" ]       && ARGS+=(--author-name "$INPUT_AUTHOR_NAME")
          [ -n "$INPUT_AUTHOR_SHORT_NAME" ] && ARGS+=(--author-short-name "$INPUT_AUTHOR_SHORT_NAME")
          [ -n "$INPUT_AUTHOR_TRADITION" ]  && ARGS+=(--author-tradition "$INPUT_AUTHOR_TRADITION")
          [ -n "$INPUT_SITE_NAME" ]         && ARGS+=(--site-name "$INPUT_SITE_NAME")
          [ -n "$INPUT_EDITION_ID" ]        && ARGS+=(--edition-id "$INPUT_EDITION_ID")
          [ -n "$INPUT_EDITION_LANG" ]      && ARGS+=(--edition-lang "$INPUT_EDITION_LANG")
          [ -n "$INPUT_TRANSLATOR" ]        && ARGS+=(--translator "$INPUT_TRANSLATOR")
          [ -n "$INPUT_EDITION_YEAR" ]      && ARGS+=(--edition-year "$INPUT_EDITION_YEAR")
          [ -n "$INPUT_LEVELS" ]            && ARGS+=(--levels "$INPUT_LEVELS")
          [ "$INPUT_FETCH_CONTENT" = "false" ] && ARGS+=(--no-fetch-content)

          python3 tools/parse_theological_text.py "${ARGS[@]}"

      - name: Commit and push generated files
        env:
          WORK_TITLE: ${{ inputs.title }}
          WORK_ID: ${{ inputs.work_id }}
          SOURCE_URL: ${{ inputs.url }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _data/ _works/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$(cat <<EOF
          Add ${WORK_TITLE} (${WORK_ID})

          Generated by the Theological Text Parser from:
          ${SOURCE_URL}
          EOF
          )"
            git push
          fi
