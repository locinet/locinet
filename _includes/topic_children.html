{% assign children = children | default: empty %}

{% if children.size > 0 %}
  {% assign margin = parent_level | times: 20 %}
  {% for subtopic in children %}
    <h{{ parent_level }} id="{{ subtopic.id }}" style="margin-left: {{ margin }}px;">
      {{ subtopic.name }}
    </h{{ parent_level }}>
    {% if subtopic.description %}
      <p style="margin-left: {{ margin }}px;"><em>{{ subtopic.description }}</em></p>
    {% endif %}

    {% comment %}Debug info{% endcomment %}
    <p style="margin-left: {{ margin }}px; color: purple; font-size: small;">
      DEBUG: topic_id={{ subtopic.id }}, children={{ subtopic.children | default: empty | size }}, links={{ topic_html[subtopic.id] | default: "" | split: "<li>" | size | minus: 1 }}
    </p>

    {% assign links_html = topic_html[subtopic.id] | default: "" %}
    {% if links_html != "" %}
      <ul style="margin-left: {{ margin }}px;">
        {{ links_html | raw }}
      </ul>
    {% endif %}

    {% assign next_children = subtopic.children | default: empty %}
    {% assign max_depth = 6 %}
    {% if next_children.size > 0 and parent_level < max_depth %}
      {% assign next_level = parent_level | plus: 1 %}
      {% include topic_children.html 
         children=next_children 
         parent_level=next_level 
         topic_html=topic_html %}
    {% endif %}
  {% endfor %}
{% else %}
  <p style="margin-left: {{ margin }}px; color: orange; font-size: small;">
    DEBUG: No children at this level
  </p>
{% endif %}
